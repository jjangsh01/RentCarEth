// src/components/CarList.jsx
import { useEffect, useState } from "react";
import { ethers } from "ethers";
import CarRegistryABI from "../abi/CarRegistry.json";
import CarRentalABI from "../abi/CarRental.json";

const CarList = ({ signer, account }) => {
    const [cars, setCars] = useState([]);
    const [msg, setMsg] = useState("");
    const [selectedRental, setSelectedRental] = useState(null);

    const statusMap = {
        0: "ğŸŸ¢ ì‚¬ìš© ê°€ëŠ¥",
        1: "ğŸŸ¡ ëŒ€ì—¬ ì¤‘",
        2: "ğŸ”§ ì ê²€ ì¤‘",
    };

    const registryContract = new ethers.Contract(import.meta.env.VITE_CONTRACT_REGISTRY, CarRegistryABI.abi, signer);

    const rentalContract = new ethers.Contract(import.meta.env.VITE_CONTRACT_RENTAL, CarRentalABI.abi, signer);

    useEffect(() => {
        const loadCars = async () => {
            try {
                const plateNumbers = await registryContract.getCarPlates();
                const carList = [];

                for (const plateNumber of plateNumbers) {
                    const [plate, model, location, pricePerDay, status, renter, owner] = await registryContract.getCar(plateNumber);

                    const isMyCar = owner.toLowerCase() === account.toLowerCase();
                    const isAvailable = Number(status) === 0;

                    // âœ… í•„í„°: ë‚´ê°€ ë“±ë¡í•˜ì§€ ì•Šì€ + ì‚¬ìš© ê°€ëŠ¥í•œ ì°¨ëŸ‰ë§Œ í¬í•¨
                    if (!isMyCar && isAvailable) {
                        carList.push({
                            id: plate,
                            model,
                            location,
                            pricePerDay: ethers.formatEther(pricePerDay),
                            status: Number(status),
                            renter: renter.toLowerCase(),
                            owner: owner.toLowerCase(),
                        });
                    }
                }

                setCars(carList);
            } catch (error) {
                console.error("ğŸš¨ ì°¨ëŸ‰ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
            }
        };

        if (signer) {
            loadCars();
        }
    }, [signer]);

    const rentCar = async (plateNumber, pricePerDay) => {
        try {
            setMsg("â³ ëŒ€ì—¬ ì²˜ë¦¬ ì¤‘...");
            const rentalFee = ethers.parseEther(pricePerDay);
            const deposit = rentalFee; // ì˜ˆ: ë³´ì¦ê¸ˆ = ë Œíƒˆ ìš”ê¸ˆê³¼ ë™ì¼
            const totalFee = rentalFee + deposit; // BigInt ì—°ì‚°

            const tx = await rentalContract.rentCar(plateNumber, {
                value: totalFee,
            });

            await tx.wait();
            setMsg("âœ… ì°¨ëŸ‰ ëŒ€ì—¬ ì™„ë£Œ!");

            // ìƒíƒœ ë‹¤ì‹œ ë¡œë“œ
            const updatedCars = cars.filter((car) => car.id !== plateNumber);
            setCars(updatedCars);
        } catch (error) {
            console.error("âŒ ëŒ€ì—¬ ì‹¤íŒ¨:", error);
            setMsg(`âŒ ëŒ€ì—¬ ì‹¤íŒ¨: ${error.message}`);
        }
    };

    const returnCar = async (plateNumber) => {
        try {
            setMsg("â³ ë°˜ë‚© ì²˜ë¦¬ ì¤‘...");
            const tx = await rentalContract.completeRental(plateNumber);
            await tx.wait();
            setMsg("âœ… ì°¨ëŸ‰ ë°˜ë‚© ì™„ë£Œ!");
            await showRentalInfo(plateNumber);
        } catch (error) {
            console.error("âŒ ë°˜ë‚© ì‹¤íŒ¨:", error);
            setMsg(`âŒ ë°˜ë‚© ì‹¤íŒ¨: ${error.message}`);
        }
    };

    const showRentalInfo = async (plateNumber) => {
        try {
            const [renter, amountPaid, timestamp, returned] = await rentalContract.getRentalInfo(plateNumber);

            if (renter === "0x0000000000000000000000000000000000000000" || Number(amountPaid) === 0) {
                setSelectedRental(null);
                return;
            }

            setSelectedRental({
                plateNumber,
                renter,
                amount: ethers.formatEther(amountPaid),
                date: new Date(Number(timestamp) * 1000).toLocaleString(),
                returned,
            });
        } catch (err) {
            console.error("ğŸš¨ ê³„ì•½ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:", err);
        }
    };

    return (
        <div>
            <h2 className="text-xl font-semibold text-white mb-4">ğŸš˜ ë ŒíŠ¸ ê°€ëŠ¥í•œ ì°¨ëŸ‰</h2>

            {msg && <p className="text-sm text-purple-200 mb-2">{msg}</p>}

            {cars.length === 0 ? (
                <p className="text-sm text-gray-300">ğŸ“­ í˜„ì¬ ëŒ€ì—¬ ê°€ëŠ¥í•œ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            ) : (
                <div className="grid gap-6 sm:grid-cols-2 md:grid-cols-3">
                    {cars.map((car) => (
                        <div key={car.id} className="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-4 shadow-md animate-fade-in-up">
                            {/* ì´ë¯¸ì§€ */}
                            <img src={`https://source.unsplash.com/400x240/?car,${car.model}`} alt={car.model} className="rounded-xl mb-3 w-full h-40 object-cover shadow" />

                            {/* ì •ë³´ */}
                            <div className="text-white space-y-1 mb-4">
                                <h3 className="text-lg font-bold">{car.model}</h3>
                                <p className="text-sm text-gray-300">ğŸ“ {car.location}</p>
                                <p className="text-sm text-gray-300">ğŸ’° {car.pricePerDay} ETH</p>
                                <p className="text-sm">{statusMap[car.status]}</p>
                            </div>

                            {/* ë²„íŠ¼ */}
                            <div className="flex gap-2">
                                <button onClick={() => rentCar(car.id, car.pricePerDay)} className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition text-sm">
                                    ëŒ€ì—¬í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            )}

            {selectedRental && (
                <div className="mt-6">
                    <RentalInfoModal rental={selectedRental} onClose={() => setSelectedRental(null)} />
                </div>
            )}
        </div>
    );
};

export default CarList;
